<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
               xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
               xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
               xmlns:viewmodels="clr-namespace:T20FichaComDB.MVVM.ViewModels"
               xmlns:entities="clr-namespace:T20FichaComDB.Data.Entities"
               xmlns:converters="clr-namespace:T20FichaComDB.Converters"
               x:Class="T20FichaComDB.MVVM.Views.Popups.SelecaoMagiasPopupView"
               x:DataType="viewmodels:SelecaoMagiasPopupViewModel"
               Color="Transparent">

    <toolkit:Popup.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </toolkit:Popup.Resources>

    <Frame Margin="15" Padding="0" CornerRadius="10" BorderColor="Gray" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}" VerticalOptions="Center" HorizontalOptions="Center" WidthRequest="350">
        <VerticalStackLayout>
            <Label Text="{Binding TituloPopup}" FontSize="Large" FontAttributes="Bold" HorizontalTextAlignment="Center" Padding="10" BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"/>

            <ScrollView MaximumHeightRequest="450" Padding="10">
                <VerticalStackLayout Spacing="10">

                    <CollectionView ItemsSource="{Binding MagiasDisponiveis}"
                                    SelectionMode="Single"
                                    SelectedItem="{Binding MagiaSelecionadaNaLista, Mode=OneWayToSource}" 
                                    SelectionChangedCommand="{Binding SelecionarMagiaParaDetalheCommand}" 
                                    SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Self}}" 
                                    IsVisible="{Binding IsAddingMode}"
                                    HeightRequest="150"
                                    EmptyView="Nenhuma magia disponível para este círculo.">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="entities:MagiasData">
                                <Label Padding="5,2">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding Nome}" FontAttributes="Bold"/>
                                            <Span Text=" | "/>
                                            <Span Text="{Binding Tipo}"/>
                                            <Span Text=" ("/>
                                            <Span Text="{Binding Escola}"/>
                                            <Span Text=")"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Border StrokeShape="RoundRectangle 5"
                            Padding="10"
                            IsVisible="{Binding MostrarDetalhes}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray700}}">
                        <ScrollView>
                            <VerticalStackLayout Spacing="5">
                                <Label FontSize="Medium" FontAttributes="Bold">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding MagiaEmDetalhe.Nome}"/>
                                            <Span Text=" ("/>
                                            <Span Text="{Binding MagiaEmDetalhe.Tipo}"/>
                                            <Span Text=" "/>
                                            <Span Text="{Binding MagiaEmDetalhe.Circulo}"/>
                                            <Span Text=")"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding MagiaEmDetalhe.Escola, StringFormat='Escola: {0}'}" />
                                <Label>
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="Exec: " FontAttributes="Bold"/>
                                            <Span Text="{Binding MagiaEmDetalhe.Execucao}"/>
                                            <Span Text=" | Alc: " FontAttributes="Bold"/>
                                            <Span Text="{Binding MagiaEmDetalhe.Alcance}"/>
                                            <Span Text=" | Dur: " FontAttributes="Bold"/>
                                            <Span Text="{Binding MagiaEmDetalhe.Duracao}"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding MagiaEmDetalhe.AlvoAreaEfeito, StringFormat='Alvo/Área: {0}'}" />
                                <Label>
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="Resistência: " FontAttributes="Bold"/>
                                            <Span Text="{Binding MagiaEmDetalhe.Resistencia}"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label Text="{Binding MagiaEmDetalhe.Descricao}" LineBreakMode="WordWrap"/>
                            </VerticalStackLayout>
                        </ScrollView>
                    </Border>

                </VerticalStackLayout>
            </ScrollView>

            <Grid ColumnDefinitions="*,*" Padding="10">
                <Button Grid.Column="1"
                        Text="Adicionar"
                        Command="{Binding ConfirmarAdicaoCommand}"
                        IsEnabled="{Binding PodeAdicionar}" 
                        IsVisible="{Binding IsAddingMode}"
                        HorizontalOptions="Fill"/>

                <Button Grid.Column="1" 
                        Text="Remover Magia"
                        Command="{Binding ConfirmarRemocaoCommand}"
                        IsEnabled="{Binding PodeRemover}"
                        IsVisible="{Binding IsAddingMode, Converter={StaticResource InverseBoolConverter}}"
                        BackgroundColor="Red" TextColor="White" HorizontalOptions="Fill"/>

                <Button Grid.Column="0"
                        Text="{Binding IsAddingMode, Converter={StaticResource InverseBoolConverter}, ConverterParameter='Fechar|Cancelar', FallbackValue='Cancelar'}"
                        Command="{Binding FecharPopupCommand}"
                        HorizontalOptions="Fill"/>
            </Grid>
        </VerticalStackLayout>
    </Frame>
</toolkit:Popup>